<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>By Selim AtÄ±f Zinciri GÃ¶rselleÅŸtirici</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    margin: 0; padding: 0;
    background: #f8f9fa;
    color: #333;
  }
  header {
    background: linear-gradient(90deg,#004e92,#000428);
    color: white; padding: 20px; text-align: center;
    font-size: 1.8em; font-weight: bold;
  }
  main {
    padding: 20px; max-width: 1100px; margin: auto;
  }
  input {
    padding: 10px; width: 60%; border-radius: 6px;
    border: 1px solid #ccc;
  }
  button {
    padding: 10px 15px; margin-left: 5px;
    background: #007bff; color: white; border: none;
    border-radius: 6px; cursor: pointer;
  }
  button:hover { background: #0056b3; }
  #chart { margin-top: 40px; text-align: center; }
  svg { width: 100%; height: 600px; background: #fff; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
  .link { stroke-opacity: 0.6; }
  .node circle { cursor: pointer; stroke: #333; stroke-width: 1px; }
  .node text { font-size: 12px; pointer-events: none; }
  footer {
    text-align: center; margin-top: 30px; font-size: 0.85em;
    color: #555; padding: 15px;
  }
  #stats {
    margin-top: 20px; background: #fff; border-radius: 8px; padding: 15px;
    box-shadow: 0 0 8px rgba(0,0,0,0.05);
  }
  #note {
    margin-top: 10px; color: #666; font-size: 0.9em;
  }
</style>
</head>
<body>
<header>By Selim AtÄ±f Zinciri GÃ¶rselleÅŸtirici</header>
<main>
  <p>ğŸ” DOI giriniz:</p>
  <input type="text" id="doi" placeholder="Ã–rnek: 10.1109/5.771073">
  <button onclick="fetchData()">Analiz Et</button>
  <button onclick="downloadPNG()">ğŸ“¸ PNG</button>
  <button onclick="downloadPDF()">ğŸ“„ PDF</button>
  <div id="note">ğŸ’¡ Not: Grafik Ã¼zerindeki dÃ¼ÄŸÃ¼mlere tÄ±klayarak detaylarÄ± gÃ¶rebilirsiniz.</div>
  <div id="chart"></div>
  <div id="stats"></div>
</main>
<footer>
  Â© Selim Ã–MÃœR â€” <a href="mailto:omurselim@gmail.com">omurselim@gmail.com</a> â€” Ä°zinsiz kullanÄ±lamaz.
</footer>

<script>
async function fetchData() {
  const doi = document.getElementById("doi").value.trim();
  if (!doi) return alert("LÃ¼tfen DOI girin!");

  document.getElementById("chart").innerHTML = "â³ Veri Ã§ekiliyor...";
  document.getElementById("stats").innerHTML = "";

  try {
    // Proxy ile CORS hatasÄ±nÄ± engelle
    const proxy = "https://api.allorigins.win/raw?url=";
    const apiUrl = `https://api.openalex.org/works/https://doi.org/${doi}`;

    const res = await fetch(proxy + encodeURIComponent(apiUrl));
    if (!res.ok) throw new Error("Veri alÄ±namadÄ±");
    const data = await res.json();

    if (!data.id) throw new Error("GeÃ§ersiz veri");

    const citesRes = await fetch(proxy + encodeURIComponent(data.cited_by_api_url));
    const citesData = await citesRes.json();

    drawGraph(data, citesData.results || []);
  } catch (err) {
    document.getElementById("chart").innerHTML = `âŒ Veri alÄ±namadÄ±: ${err.message}`;
  }
}

function drawGraph(mainWork, citations) {
  document.getElementById("chart").innerHTML = "";
  const nodes = [{ id: mainWork.id, title: mainWork.display_name, group: "main", doi: mainWork.doi }];
  const links = [];

  citations.forEach(c => {
    nodes.push({ id: c.id, title: c.display_name, group: "cite", doi: c.doi });
    links.push({ source: c.id, target: mainWork.id, type: "cited" });
  });

  const svg = d3.select("#chart").append("svg");
  const width = +svg.node().getBoundingClientRect().width;
  const height = +svg.node().getBoundingClientRect().height;

  const color = d => d.group === "main" ? "#FFD700" : "#4CAF50";

  const simulation = d3.forceSimulation(nodes)
    .force("link", d3.forceLink(links).id(d => d.id).distance(120))
    .force("charge", d3.forceManyBody().strength(-180))
    .force("center", d3.forceCenter(width / 2, height / 2))
    .force("collision", d3.forceCollide().radius(45));

  const link = svg.append("g")
    .attr("stroke", "#aaa")
    .attr("stroke-width", 1.2)
    .selectAll("line")
    .data(links)
    .join("line")
    .attr("class", "link");

  const node = svg.append("g")
    .selectAll("circle")
    .data(nodes)
    .join("circle")
    .attr("r", d => d.group === "main" ? 15 : 8)
    .attr("fill", color)
    .on("click", (e, d) => {
      if (d.doi) window.open(`https://doi.org/${d.doi}`, "_blank");
    })
    .call(drag(simulation));

  const text = svg.append("g")
    .selectAll("text")
    .data(nodes)
    .join("text")
    .text(d => d.title.length > 40 ? d.title.slice(0,40)+"â€¦" : d.title)
    .attr("x", 10).attr("y", 3);

  simulation.on("tick", () => {
    link.attr("x1", d => d.source.x)
        .attr("y1", d => d.source.y)
        .attr("x2", d => d.target.x)
        .attr("y2", d => d.target.y);
    node.attr("cx", d => d.x)
        .attr("cy", d => d.y);
    text.attr("transform", d => `translate(${d.x+10},${d.y})`);
  });

  document.getElementById("stats").innerHTML = `
    <h3>ğŸ“Š Makale Ã–zeti</h3>
    <p><b>BaÅŸlÄ±k:</b> ${mainWork.display_name}</p>
    <p><b>AtÄ±f SayÄ±sÄ±:</b> ${mainWork.cited_by_count}</p>
    <p><b>KaynakÃ§a SayÄ±sÄ±:</b> ${mainWork.referenced_works.length}</p>
    <p><b>DOI:</b> ${mainWork.doi}</p>
  `;
}

function drag(simulation) {
  function dragstarted(e) {
    if (!e.active) simulation.alphaTarget(0.3).restart();
    e.subject.fx = e.subject.x;
    e.subject.fy = e.subject.y;
  }
  function dragged(e) {
    e.subject.fx = e.x;
    e.subject.fy = e.y;
  }
  function dragended(e) {
    if (!e.active) simulation.alphaTarget(0);
    e.subject.fx = null;
    e.subject.fy = null;
  }
  return d3.drag()
    .on("start", dragstarted)
    .on("drag", dragged)
    .on("end", dragended);
}

async function downloadPNG() {
  const chart = document.getElementById("chart");
  const canvas = await html2canvas(chart);
  const link = document.createElement("a");
  link.download = "atif_zinciri.png";
  link.href = canvas.toDataURL();
  link.click();
}

async function downloadPDF() {
  const chart = document.getElementById("chart");
  const canvas = await html2canvas(chart);
  const imgData = canvas.toDataURL("image/png");
  const pdf = new jspdf.jsPDF("l", "mm", "a4");
  const width = pdf.internal.pageSize.getWidth();
  const height = pdf.internal.pageSize.getHeight();
  pdf.addImage(imgData, "PNG", 10, 10, width - 20, height - 20);
  pdf.save("atif_zinciri.pdf");
}
</script>
</body>
</html>
